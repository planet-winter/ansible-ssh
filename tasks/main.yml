---


- name: ubuntu install universe repository for firewalld
  apt_repository:
    repo: "{{item}}"
  when: ansible_distribution == 'Ubuntu'
  with_items:
    - 'deb http://archive.ubuntu.com/ubuntu {{ansible_distribution_release}} universe'

- name: install firewalld
  action: "{{ ansible_pkg_mgr }} state=installed name=firewalld"

- name: install missing packackage on fedoras
  action: "{{ ansible_pkg_mgr }} state=installed name=python-firewall"
  when:  ( ansible_distribution == "Fedora" )
                                

- name: configure sshd
  template: src=sshd_config.j2 dest=/etc/ssh/sshd_config owner=root group=root mode=0600
  notify:
    - restart sshd

- name: wait for ssh to be back
  local_action: wait_for port=22 host="{{ ansible_ssh_host | default(inventory_hostname) }}" search_regex=OpenSSH delay=10
    

- name: enable and start firewalld to avoid issue https://github.com/ansible/ansible-modules-extras/issues/1282
  service:
    name: firewalld
    state: started
    enabled: yes

  
- name: ensure ssh is always open
  firewalld: service=ssh permanent=true state=enabled immediate=true zone=public


